@page
@model GestionRues.Pages.Busqueda
@{
    Layout = "Shared/_Layout";
}

<div id="data-table"></div>

@section Scripts {
    <script>
        $(function(){
            $("#data-table").dxDataGrid({
                dataSource: "/Busqueda?handler=EmpresasResponse",
                keyExpr: "id",
                columnAutoWidth: true,
                rowAlternationEnabled: true,
                showBorders: true,
                paging: {
                    pageSize: 10
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [5, 10, 20]
                },
                filterRow: {
                    visible: true,
                    applyFilter: "auto"
                },
                searchPanel: {
                    visible: true,
                    placeholder: "Buscar..."
                },
                headerFilter: {
                    visible: true
                },
                grouping: {
                    autoExpandAll: false
                },
                columns: [
                    {
                        dataField: "identificacion",
                        caption: "Identificación",
                        width: 120
                    },
                    {
                        dataField: "nombre",
                        caption: "Nombre",
                        minWidth: 200
                    },
                    {
                        dataField: "categoriaDeMatricula",
                        caption: "Categoría Matrícula",
                        width: 150
                    },
                    {
                        dataField: "tipoDeSociedad",
                        caption: "Tipo Sociedad",
                        width: 130
                    },
                    {
                        dataField: "numeroDeMatricula",
                        caption: "N° Matrícula",
                        width: 120
                    },
                    {
                        dataField: "fechaDeMatricula",
                        caption: "Fecha Matrícula",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 130
                    },
                    {
                        dataField: "estadoMatricula",
                        caption: "Estado",
                        width: 100,
                        allowHiding: false
                    },
                    {
                        dataField: "actividadesEconomicas",
                        caption: "Actividades",
                        minWidth: 250,
                        wordWrapEnabled: true
                    },
                    {
                        caption: "Acciones",
                        width: 100,
                        type: "buttons",
                        buttons: [{
                            hint: "Editar",
                            icon: "edit",
                            onClick: function(e) {
                                const id = e.row.data.id;
                                window.location.href = `/Registro?handler=EmpresaById&id=${id}`;
                            }
                        }, {
                            hint: "Eliminar",
                            icon: "trash",
                            type: "danger",
                            onClick: function(e) {
                                const id = e.row.data.id;
                                DevExpress.ui.dialog.confirm("¿Está seguro de eliminar esta empresa?", "Confirmar eliminación")
                                    .done(function(result) {
                                        if(result) {
                                            $.ajax({
                                                url: `/Busqueda?handler=DeleteEmpresa&id=${id}`,
                                                method: "POST"
                                            }).done(function() {
                                                DevExpress.ui.notify("Empresa eliminada correctamente", "success", 2000);
                                                e.component.refresh();
                                            }).fail(function() {
                                                DevExpress.ui.notify("Error al eliminar la empresa", "error", 2000);
                                            });
                                        }
                                    });
                            }
                        }]
                    }
                ],
                toolbar: {
                    items: [
                        {
                            location: 'before',
                            widget: 'dxButton',
                            options: {
                                text: 'Nueva Empresa',
                                icon: 'add',
                                onClick: function() {
                                    window.location.href = '/Registro';
                                }
                            }
                        },
                        'searchPanel'
                    ]
                },
                allowColumnResizing: true,
                allowColumnReordering: true,
                columnChooser: {
                    enabled: true,
                    mode: 'dragAndDrop'
                }
            });
        });
    </script>
}